name: Changelog Notifier

on:
  schedule:
    - cron: "0 */3 * * *"
  workflow_dispatch:

concurrency:
  group: changelog-notifier
  cancel-in-progress: false

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install dependencies
        run: corepack enable && pnpm install --frozen-lockfile

      - name: Fetch changelogs and detect diffs
        id: fetch-diff
        run: npx tsx src/scripts/fetch-and-diff.ts
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_CHANNEL_ID_CLAUDE_CODE: ${{ secrets.SLACK_CHANNEL_ID_CLAUDE_CODE }}
          SLACK_CHANNEL_ID_CODEX: ${{ secrets.SLACK_CHANNEL_ID_CODEX }}
          SLACK_CHANNEL_ID_COPILOT_CLI: ${{ secrets.SLACK_CHANNEL_ID_COPILOT_CLI }}

      - name: Generate summaries with Claude
        if: steps.fetch-diff.outputs.has_changes == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            data/diffs/ ディレクトリ内の各 Markdown ファイルを読み取り、
            バージョンごとに日本語要約を生成してください。

            ファイル名の形式は `{source}-{version}.md` です（例: `claude-code-2.1.63.md`）。
            各ファイルを読み取り、対応する `data/summaries/{source}-{version}.md` に
            以下のフォーマットで日本語要約を書き出してください。

            ## フォーマット

            ## ひとこと

            - このバージョンの目玉変更をひとことでわかりやすく

            ## 変更内容

            （該当する変更があるカテゴリのみ、以下の順序で出力する。該当なしのカテゴリは省略する）

            ### 破壊的変更
            - xxx  ← 後方互換性のない変更（Breaking change キーワード）

            ### セキュリティ
            - xxx  ← セキュリティ修正・脆弱性対応（Security, CVE, vulnerability, sandbox 関連）

            ### 新規追加
            - xxx  ← 新機能・新コマンドの追加（Added, Add, New, Introduce）

            ### 修正
            - xxx  ← バグ修正（Fixed, Fix, Patched, Resolved）

            ### 改善
            - xxx  ← 既存機能の使い勝手・UX 改善（Improved, Improve, Enhanced, Enhance）

            ### パフォーマンス
            - xxx  ← 速度・メモリ・効率の改善（Performance, Speed, Memory, overhead）

            ### 削除
            - xxx  ← 機能・オプションの削除（Removed, Remove, Dropped）

            ### 非推奨
            - xxx  ← 将来的に削除予定（Deprecated, Deprecate）

            ### その他
            - xxx  ← 上記のどれにも属さない変更

            ## 用語解説

            - 特殊な用語があればピックアップして解説（なければこのセクションごと省略）

            例: `data/diffs/claude-code-2.1.63.md` → `data/summaries/claude-code-2.1.63.md` に書き出す。
            ファイルが複数ある場合はすべて処理してください。
          claude_args: "--max-turns 50 --allowedTools Read,Write,Edit,Glob"

      - name: Post notifications to Slack
        if: steps.fetch-diff.outputs.has_changes == 'true'
        run: npx tsx src/scripts/notify.ts
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          SLACK_CHANNEL_ID_CLAUDE_CODE: ${{ secrets.SLACK_CHANNEL_ID_CLAUDE_CODE }}
          SLACK_CHANNEL_ID_CODEX: ${{ secrets.SLACK_CHANNEL_ID_CODEX }}
          SLACK_CHANNEL_ID_COPILOT_CLI: ${{ secrets.SLACK_CHANNEL_ID_COPILOT_CLI }}

      - name: Commit and push changes
        if: steps.fetch-diff.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/snapshots/ data/state.json
          git diff --cached --quiet || git commit -m "chore: update changelog snapshots"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push
