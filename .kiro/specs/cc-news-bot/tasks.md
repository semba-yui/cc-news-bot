# Implementation Plan

## Tasks

- [x] 1. プロジェクト基盤セットアップ
- [x] 1.1 TypeScript 実行環境と依存パッケージの準備
  - tsx による TypeScript 直接実行環境を構成し、必要な依存パッケージ（diff ライブラリ等）をインストールする
  - ソース設定（3つの監視対象の名前・種別・URL）を定数として定義する
  - data/ 配下のディレクトリ構成（snapshots, diffs, summaries, current）を初期化するスクリプトを用意する
  - _Requirements: 1.3_

- [ ] 2. 状態管理サービスの実装
- [x] 2.1 (P) スナップショットの読み書き機能
  - ソースごとのスナップショットファイル（Markdown）を読み込み、存在しない場合は null を返す
  - スナップショットを指定パスに書き出す機能を実装する
  - _Requirements: 3.1, 4.1, 8.1_

- [x] 2.2 (P) 状態メタデータの永続化
  - state.json の読み込み・書き出し機能を実装する（ソースごとのハッシュ値と最終チェック日時を管理）
  - ファイルが存在しない場合（初回実行）は空の初期状態を返す
  - 最終実行日時（lastRunAt）を ISO 8601 形式で記録する
  - _Requirements: 8.1, 8.3_

- [ ] 3. Changelog 取得サービスの実装
- [x] 3.1 (P) Raw Markdown の HTTP 取得
  - 指定 URL から Markdown テキストを HTTP GET で取得する機能を実装する
  - claude-code と copilot-cli の 2 ソースがこの方式を使用する
  - 30 秒のタイムアウトを設定し、取得失敗時はエラー情報を含む結果を返す
  - _Requirements: 2.1, 2.3, 2.4_

- [x] 3.2 (P) GitHub Releases API によるリリース情報の取得
  - GitHub Releases API から最新 10 件のリリースを取得し、タグ名・公開日・本文を結合した Markdown を構成する
  - GITHUB_TOKEN による認証済みリクエストを使用してレート制限を回避する（5,000 req/hour）
  - リリースは公開日の降順（最新が先頭）で `## {tag_name} ({published_at})\n{body}` の形式で連結する
  - 取得失敗時は他ソースに影響を与えず、エラー情報を含む結果を返す
  - _Requirements: 2.2, 2.4_

- [x] 3.3 全ソース一括取得のオーケストレーション
  - 3 つの監視対象に対して一括で changelog 取得を実行し、各ソースの成功・失敗を個別に管理する
  - 1 つのソースの取得失敗が他のソースの処理を妨げないようにする
  - _Requirements: 1.3, 2.4, 7.2_

- [ ] 4. 差分検出サービスの実装
- [x] 4.1 ハッシュベースの変更検知と差分テキスト生成
  - SHA-256 ハッシュで前回スナップショットとの変更有無を高速判定する
  - 変更がある場合のみ行単位の unified diff テキストを生成する
  - 前回スナップショットが存在しない場合（初回実行）は変更なし（hasChanges: false）として扱い、スナップショット保存のみ行う
  - 各ソースを独立して処理し、あるソースの結果が他に影響しない
  - 差分テキストを data/diffs/ に書き出す
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2_

- [x] 5. Slack 通知サービスの実装
- [x] 5.1 (P) 要約メッセージの投稿とスレッド返信
  - Slack Bot Token を使用して指定チャンネルにメインメッセージ（日本語要約）を投稿する
  - 投稿成功時に返却されるメッセージ timestamp を利用してスレッド返信（原文 diff）を投稿する
  - 投稿間に 1 秒のウェイトを挿入してレート制限に対応する
  - mrkdwn フォーマットを使用する
  - _Requirements: 6.1, 6.2, 6.3_

- [x] 5.2 (P) 長文メッセージの分割投稿
  - 原文の差分テキストが 3,500 文字を超える場合、固定文字数で分割して複数のスレッド返信として投稿する
  - 分割の閾値は 3,500 文字（Slack の 4,000 文字上限に余裕を持たせる）
  - _Requirements: 6.4_

- [x] 5.3 (P) エラー通知機能
  - changelog 取得失敗時にソース名とエラー内容を含むエラーメッセージを Slack チャンネルに投稿する
  - Slack 投稿自体が失敗した場合はワークフローログにエラーを記録し、処理を継続する
  - _Requirements: 6.5, 7.1, 7.2, 7.3_

- [ ] 6. メインオーケストレーションスクリプトの実装
- [x] 6.1 メインフロー制御の実装
  - 取得 → 差分検出 → diff ファイル書き出し → Slack 通知 → スナップショット更新の一連のフローを制御する
  - 初回実行時（スナップショットなし）はスナップショット保存のみ行い、通知をスキップする
  - 差分が検出されなかった場合は要約生成と Slack 通知をスキップする
  - 差分が検出された場合は data/diffs/ にファイルを書き出し、後続の Claude Code Action step と Slack 通知 step で使用する
  - ソースごとにエラーハンドリングを行い、1 つのソースのエラーが全体を止めないようにする
  - _Requirements: 1.3, 3.3, 3.4, 4.1, 4.2, 7.2, 8.4_

- [x] 6.2 スナップショット更新と状態保存
  - 差分が検出されたソースのスナップショットを最新の changelog で更新する
  - state.json の各ソースのハッシュ値と最終チェック日時を更新する
  - 差分が検出されなかった場合はスナップショットの更新やコミットを行わない
  - _Requirements: 8.1, 8.3, 8.4_

- [ ] 7. GitHub Actions ワークフローの実装
- [x] 7.1 ワークフロー定義と Claude Code Action 統合
  - 3 時間ごとの cron スケジュール（`0 */3 * * *`）と workflow_dispatch による手動実行に対応するワークフローを定義する
  - concurrency グループ（`changelog-notifier`, `cancel-in-progress: false`）を設定して並行実行を防止する
  - Checkout → Fetch/Diff スクリプト実行 → Claude Code Action（Automation Mode で要約生成）→ Slack 通知スクリプト実行 → 自動コミット＆プッシュの step 構成を実装する
  - Claude Code Action は `prompt` input と `allowed_tools` を使用し、data/diffs/ のファイルを読み取って data/summaries/ に日本語要約を書き出す
  - SLACK_BOT_TOKEN、CLAUDE_CODE_OAUTH_TOKEN、GITHUB_TOKEN を GitHub Secrets から参照し、ハードコードしない
  - 差分が検出されなかった場合は Claude Code Action と Slack 通知 step をスキップする条件分岐を実装する
  - 差分が検出された場合のみ自動コミット＆プッシュを実行する
  - _Requirements: 1.1, 1.2, 4.3, 5.1, 5.2, 5.3, 5.4, 8.2, 8.4, 9.1, 9.2, 9.3_

- [x] 8. 結合テストと動作検証
- [x] 8.1 初回実行シナリオの検証
  - スナップショットが存在しない状態で実行し、スナップショット保存のみ行われ Slack 通知がスキップされることを確認する
  - state.json が正しく生成されることを確認する
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 8.2 差分検出と通知フローの検証
  - スナップショットが存在する状態で changelog に変更があった場合に、差分検出 → 要約生成 → Slack 投稿 → スナップショット更新の一連フローが正しく動作することを確認する
  - 差分がない場合にスキップされることを確認する
  - 長文の差分テキストが正しく分割投稿されることを確認する
  - _Requirements: 3.2, 3.3, 3.4, 6.1, 6.2, 6.4, 8.1, 8.4_

- [x] 8.3 エラーハンドリングの検証
  - 無効な URL を使用して取得エラーが Slack に通知されることを確認する
  - 1 ソースのエラーが他ソースの処理を妨げないことを確認する
  - エラー通知にソース名とエラー内容が含まれることを確認する
  - _Requirements: 2.4, 7.1, 7.2, 7.3_

## Requirements Coverage

| Requirement | Tasks              |
| ----------- | ------------------ |
| 1.1         | 7.1                |
| 1.2         | 7.1                |
| 1.3         | 1.1, 3.3, 6.1      |
| 2.1         | 3.1                |
| 2.2         | 3.2                |
| 2.3         | 3.1                |
| 2.4         | 3.1, 3.2, 3.3, 8.3 |
| 3.1         | 2.1, 4.1           |
| 3.2         | 4.1, 8.2           |
| 3.3         | 4.1, 6.1, 8.2      |
| 3.4         | 4.1, 6.1, 8.2      |
| 3.5         | 4.1                |
| 4.1         | 2.1, 4.1, 6.1, 8.1 |
| 4.2         | 4.1, 6.1, 8.1      |
| 4.3         | 7.1, 8.1           |
| 5.1         | 7.1                |
| 5.2         | 7.1                |
| 5.3         | 7.1                |
| 5.4         | 7.1                |
| 6.1         | 5.1, 8.2           |
| 6.2         | 5.1, 8.2           |
| 6.3         | 5.1                |
| 6.4         | 5.2, 8.2           |
| 6.5         | 5.3                |
| 7.1         | 5.3, 8.3           |
| 7.2         | 3.3, 5.3, 6.1, 8.3 |
| 7.3         | 5.3, 8.3           |
| 8.1         | 2.1, 6.2, 8.2      |
| 8.2         | 7.1                |
| 8.3         | 2.2, 6.2           |
| 8.4         | 6.1, 6.2, 7.1, 8.2 |
| 9.1         | 7.1                |
| 9.2         | 7.1                |
| 9.3         | 7.1                |
